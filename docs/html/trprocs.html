<html>
<head><title>Translating Procedures</title></head>
<body bgcolor=white>
<a href="trstats.html"><img src="next.gif" border=0></a> <a href="concrsyn.html"><img src="previous.gif" border=0></a><br><br>
<font  face=helvetica size=-1>
<a href="index.html">HANDBOOK</a>
 / <a href="casestudy.html">CASE STUDY</a>
 / <a href="compiler.html">The Compiler</a>
 /<br><br>
</font>
<h1>Translating Procedures</h1>

<p>
We have just described how a source program is translated into
an internal representation.
We now discuss how to translate the internal representation
into a target program.
<p>
<table>
<tr>
<td>&nbsp; &nbsp;</td>
<td><hr></td>
</tr><td></td>
<td bgcolor="#e9e9d2">
<font size="-1">
<pre>

150  'action' Translate(Program: DECL) 
151     'rule' Translate(P): 
152        SetCurrentNesting(0) 
153        Procedure(P) 
154        Emit 
  
155  'action' Procedure(Proc: DECL) 
156     'rule' Procedure(dcl(Ident, proc(Formals,Locals,Body), Pos)) : 
157        GetCurrentNesting(-> OuterLevel) 
158        SetCurrentNesting(OuterLevel+1) 
159        DeclareList(Formals, 3 -> SizeFormals) 
160        DeclareList(Locals, SizeFormals+3 -> SizeLocals) 
161        ENT(SizeLocals) 
162        Statement(Body) 
163        RET 
164        LocalProcedures(Locals) 
165        UndeclareList(Locals) 
166        UndeclareList(Formals) 
167        SetCurrentNesting(OuterLevel) 
  
168  'action' LocalProcedures(Decls: DECLLIST) 
169     'rule' LocalProcedures(decllist(Head, Tail)) : 
170        LocalProcedure(Head) 
171        LocalProcedures(Tail) 
172     'rule' LocalProcedures(nil) 
  
173  'action' LocalProcedure(DECL) 
174     'rule' LocalProcedure(dcl(Ident, proc(Fs, Ds, S), Pos)) : 
175        HasMeaning (Ident -> object(procobj(Start,_),_,_)) 
176        LAB(Start) 
177        Procedure(dcl(Ident, proc(Fs, Ds, S), Pos)) 
178     'rule' LocalProcedure(Decl) : 

</pre>
</font>
</td>
</tr>
<tr><td></td>
<td><hr></td></tr>
</table>


<tt> Translate</tt>
<p>
The predicate <tt> Translate(Program)</tt> is invoked in the root clause
of the specification.
The whole program is merely represented as a simple procedure
without parameters.
Hence, we can simply use <tt> Procedure</tt> to process
the given abstract syntax tree.
Before calling <tt> Procedure</tt>, we initialize the current nesting level
of procedures
(which is implemented as a global variable).
After generating the code, we invoke <tt> emit</tt> to write it to the target file.
<p>
 <br>
<tt> Procedure</tt>
<p>
The predicate <tt> Procedure(Proc)</tt> handles a single procedure declaration
the abstract syntax of which is
<PRE>

   dcl(Ident, proc(Formals, Locals, Body), Pos)
</PRE>
The procedure has a name given by <tt> Ident</tt>;
formal parameters and local declarations are given by
<tt> Formals</tt> and <tt> Locals</tt>;
the procedure body is given by <tt> Body</tt>.
<p>
First, the current procedure nesting is updated accordingly.
It is reset to its old value at the end of the rule.
<p>
During the processing of <tt> Body</tt> and local procedures,
the formal parameters and the local
declarations must be accessible. Hence, they are made visible by
processing <tt> Formals</tt> and <tt> Locals</tt> with the predicate
<tt> DeclareList</tt>.
Outside the given procedure, the formal parameters
and local declarations cannot be used.
Hence, they are made invisible again (<tt> UndeclareList</tt>) after 
processing the body and the local procedures.
<p>
<tt> DeclareList</tt> (to be discussed later) has additional parameters:
<tt> DeclareList(X, Loc -> Size)</tt>
indicates that the items in <tt> X</tt> are stored from location
<tt> Loc</tt> and that they occupy <tt> Size</tt> units.
<p>
The stack frame of the procedure is organized as follows:
3 units for administrative data (static link, dynamic link, return address),
<tt> SizeFormal</tt> units as to store parameters,
and <tt> SizeLocals</tt> units to store local variables.
<p>
The target code of the procedure is given as follows:
<PRE>

   ENT(SizeLocals)
   Code of body
   RET
   Code of local procedure
</PRE>

The code for the body is generated by the predicate <tt> Statement</tt>,
the code for the local procedures is generated by <tt> LocalProcedures</tt>.
<p>
 <br>
<tt> LocalProcedures</tt>
<p>
<tt> LocalProcedures(Decls)</tt> invokes <tt> LocalProcedure</tt> for each element of
the declaration list(<tt> Decls</tt>).
<p>
 <br>
<tt> LocalProcedure</tt>
<p>
If <tt> LocalProcedure(Decl)</tt> is invoked with a procedure declaration,
it processes this declaration. Otherwise the passed element is skipped.
A procedure is processed by <tt> Procedure</tt> (in the case of a local
procedure, we first emit a start label).
<p>
We now refine the processing of procedure bodies.
We discuss statements, expressions, and designators.
<p>

<br><br>
</ul>
</ul>
</ul>
<a href="trstats.html"><img src="next.gif" border=0></a> <a href="concrsyn.html"><img src="previous.gif" border=0></a></body>
</html>
